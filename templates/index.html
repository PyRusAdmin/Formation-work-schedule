<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Календарь отпусков на октябрь 2025</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>


<div class="menu">
    <input type="checkbox" id="burger-checkbox" class="burger-checkbox">
    <label for="burger-checkbox" class="burger"></label>
    <div class="overlay"></div> <!-- Добавлено -->
    <ul class="menu-list">
        <li><a href="#" class="menu-item">Главная</a></li>
        <li><a href="/list_employees" class="menu-item">Список сотрудников</a></li>
        <li><a href="/report_card" class="menu-item">График выходов</a></li>
        <li><a href="#" class="menu-item">Контакты</a></li>
    </ul>
</div>


<div class="container">
    <h1>Календарь отпусков на октябрь 2025</h1>

    <button class="add-employee-btn" onclick="addEmployee()">Добавить сотрудника</button>

    <div id="employees-container"></div>

    <div class="summary">
        <h3>Сводная информация</h3>
        <div id="summary-content"></div>
    </div>
</div>

<script>
    // Глобальные переменные
    const employees = [];
    const month = 9; // Октябрь (0-11)
    const year = 2025;

    // Названия дней недели и месяцев (начинаем с понедельника)
    const weekdays = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
    const months = [
        'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
        'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
    ];

    // Инициализация при загрузке страницы
    window.onload = function () {
        addEmployee(); // Добавляем первого сотрудника по умолчанию
    };

    // Функция добавления нового сотрудника
    function addEmployee() {
        const employeeId = employees.length;
        const newEmployee = {
            id: employeeId,
            name: `Табельный номер`,
            vacationStart: null,
            vacationEnd: null,
            weekends: [0, 6] // по умолчанию суббота и воскресенье
        };

        employees.push(newEmployee);
        renderEmployeeSection(employeeId);
        updateCalendar();
    }

    //    Сохранение данных в базу данных
    async function saveEmployee(employeeId) {
        const employee = employees[employeeId];
        if (!employee.vacationStart || !employee.vacationEnd) {
            alert("Заполните даты отпуска перед сохранением!");
            return;
        }

        try {
            const response = await fetch('/employees/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: employee.name,
                    vacation_start: employee.vacationStart,
                    vacation_end: employee.vacationEnd,
                    weekends: employee.weekends
                })
            });
            const data = await response.json();
            console.log('Сотрудник сохранён:', data);
        } catch (error) {
            console.error('Ошибка при сохранении:', error);
        }
    }

    // Функция отображения секции сотрудника
    function renderEmployeeSection(employeeId) {
        const employee = employees[employeeId];
        const container = document.getElementById('employees-container');

        const employeeDiv = document.createElement('div');
        employeeDiv.className = 'employee-section';
        employeeDiv.id = `employee-${employeeId}`;

        employeeDiv.innerHTML = `
                <div class="employee-header">
                    <div class="employee-name">
                        <input type="text" value="${employee.name}" onchange="updateEmployeeName(${employeeId}, this.value)">
                    </div>
                    <button onclick="saveEmployee(${employeeId})">Сохранить</button>
                    <button onclick="removeEmployee(${employeeId})">Удалить сотрудника</button>
                </div>

                <div class="vacation-inputs">
                    <label>
                        Начало отпуска:
                        <input type="date" onchange="updateVacation(${employeeId}, 'start', this.value)"
                               min="2025-10-01" max="2025-10-31">
                    </label>

                    <label>
                        Конец отпуска:
                        <input type="date" onchange="updateVacation(${employeeId}, 'end', this.value)"
                               min="2025-10-01" max="2025-10-31">
                    </label>
                </div>

                <div class="custom-weekends">
                    <label>Выходные дни:</label>
                    <div class="weekend-selector">
                        ${weekdays.map((day, index) => {
            // Преобразуем индекс для соответствия стандартному представлению (0=вс, 1=пн, ..., 6=сб)
            const standardIndex = index === 6 ? 0 : index + 1;
            return `
                                <label>
                                    <input type="checkbox" ${employee.weekends.includes(standardIndex) ? 'checked' : ''}
                                           onchange="toggleWeekend(${employeeId}, ${standardIndex}, this.checked)">
                                    ${day}
                                </label>
                            `;
        }).join('')}
                    </div>
                </div>

                <div class="calendar-grid" id="calendar-${employeeId}">
                    <!-- Календарь будет сгенерирован здесь -->
                </div>
            `;

        container.appendChild(employeeDiv);
    }

    // Обновление имени сотрудника
    function updateEmployeeName(employeeId, name) {
        employees[employeeId].name = name;
        updateCalendar();
    }

    // Обновление отпуска сотрудника
    function updateVacation(employeeId, type, date) {
        if (type === 'start') {
            employees[employeeId].vacationStart = date ? new Date(date) : null;
        } else {
            employees[employeeId].vacationEnd = date ? new Date(date) : null;
        }
        updateCalendar();
    }

    // Переключение выходного дня
    function toggleWeekend(employeeId, dayIndex, isChecked) {
        const weekends = employees[employeeId].weekends;
        if (isChecked) {
            if (!weekends.includes(dayIndex)) {
                weekends.push(dayIndex);
            }
        } else {
            const index = weekends.indexOf(dayIndex);
            if (index > -1) {
                weekends.splice(index, 1);
            }
        }
        updateCalendar();
    }

    // Удаление сотрудника
    function removeEmployee(employeeId) {
        if (employees.length <= 1) {
            alert('Нельзя удалить последнего сотрудника');
            return;
        }

        employees.splice(employeeId, 1);
        // Переиндексируем оставшихся сотрудников
        for (let i = employeeId; i < employees.length; i++) {
            employees[i].id = i;
        }

        renderAllEmployees();
        updateCalendar();
    }

    // Перерисовка всех сотрудников
    function renderAllEmployees() {
        const container = document.getElementById('employees-container');
        container.innerHTML = '';

        employees.forEach((_, index) => {
            renderEmployeeSection(index);
        });
    }

    // Обновление календаря для всех сотрудников
    function updateCalendar() {
        employees.forEach(employee => {
            renderCalendarForEmployee(employee);
        });
        updateSummary();
    }

    // Отображение календаря для конкретного сотрудника
    function renderCalendarForEmployee(employee) {
        const calendarContainer = document.getElementById(`calendar-${employee.id}`);
        if (!calendarContainer) return;

        // Очищаем контейнер
        calendarContainer.innerHTML = '';

        // Добавляем заголовки дней недели (начиная с понедельника)
        weekdays.forEach(day => {
            const header = document.createElement('div');
            header.className = 'calendar-header';
            header.textContent = day;
            calendarContainer.appendChild(header);
        });

        // Получаем первый день месяца
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        // День недели первого числа (0 - воскресенье, 1 - понедельник, и т.д.)
        const firstDayOfWeek = firstDay.getDay();

        // Корректируем для начала недели с понедельника
        // 0 (вс) -> 6, 1 (пн) -> 0, 2 (вт) -> 1, ..., 6 (сб) -> 5
        const adjustedFirstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;

        // Добавляем пустые ячейки для дней предыдущего месяца
        for (let i = 0; i < adjustedFirstDayOfWeek; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day';
            calendarContainer.appendChild(emptyDay);
        }

        // Добавляем ячейки для дней октября
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const currentDate = new Date(year, month, day);
            const dayOfWeek = currentDate.getDay();

            // Преобразуем день недели для нашего представления (0=пн, 1=вт, ..., 6=вс)
            const adjustedDayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';

            // Определяем классы для стилизации
            if (employee.weekends.includes(dayOfWeek)) {
                dayElement.classList.add('weekend');
            }

            // Проверяем, находится ли день в отпуске
            if (isDateInVacation(currentDate, employee)) {
                dayElement.classList.add('vacation');
            } else if (!employee.weekends.includes(dayOfWeek)) {
                dayElement.classList.add('working');
            }

            // Добавляем номер дня и статус
            dayElement.innerHTML = `
                    <div class="day-number">${day}</div>
                    <div class="day-status">${getDayStatus(currentDate, employee)}</div>
                `;

            calendarContainer.appendChild(dayElement);
        }
    }

    // Проверка, находится ли дата в отпуске
    function isDateInVacation(date, employee) {
        if (!employee.vacationStart || !employee.vacationEnd) return false;

        const startDate = new Date(employee.vacationStart);
        const endDate = new Date(employee.vacationEnd);

        // Устанавливаем время в 00:00 для корректного сравнения
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(0, 0, 0, 0);
        date.setHours(0, 0, 0, 0);

        return date >= startDate && date <= endDate;
    }

    // Получение статуса дня
    function getDayStatus(date, employee) {
        const dayOfWeek = date.getDay();

        if (employee.weekends.includes(dayOfWeek)) {
            return 'Выходной';
        }

        if (isDateInVacation(date, employee)) {
            return 'Отпуск';
        }

        return 'Рабочий';
    }

    // Обновление сводной информации
    function updateSummary() {
        const summaryContainer = document.getElementById('summary-content');
        if (!summaryContainer) return;

        const summary = employees.map(employee => {
            const stats = calculateEmployeeStats(employee);
            return `
                    <div class="summary-item">
                        <strong>${employee.name}:</strong>
                        Рабочих дней: ${stats.workingDays},
                        Отпускных дней: ${stats.vacationDays},
                        Выходных: ${stats.weekendDays}
                    </div>
                `;
        }).join('');

        summaryContainer.innerHTML = summary;
    }

    // Расчет статистики для сотрудника
    function calculateEmployeeStats(employee) {
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        let workingDays = 0;
        let vacationDays = 0;
        let weekendDays = 0;

        for (let day = 1; day <= lastDay.getDate(); day++) {
            const currentDate = new Date(year, month, day);
            const dayOfWeek = currentDate.getDay();

            if (employee.weekends.includes(dayOfWeek)) {
                weekendDays++;
            } else if (isDateInVacation(currentDate, employee)) {
                vacationDays++;
            } else {
                workingDays++;
            }
        }

        return {workingDays, vacationDays, weekendDays};
    }
</script>


<script>
    // Закрытие меню при клике на оверлей
    document.querySelector('.overlay').addEventListener('click', function() {
        document.getElementById('burger-checkbox').checked = false;
    });
</script>


</body>
</html>