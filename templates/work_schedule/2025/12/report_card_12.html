{% extends "base.html" %}

{% block title %}График работы сотрудников на декабрь 2025{% endblock %}

{% block content %}

<h1 class="text-2xl font-bold mb-6 text-center">График работы сотрудников на декабрь 2025</h1>

<!-- Filters -->
<div class="bg-white p-4 rounded-lg shadow-md mb-6">
    <h2 class="text-lg font-semibold mb-4">Фильтры</h2>
    <div class="grid grid-cols-1 md:grid-cols-7 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700">КСП</label>
            <input type="text" id="filter-ksp"
                   class="mt-1 block max-w-xs border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Наименование КСП</label>
            <input type="text" id="filter-name"
                   class="mt-1 block max-w-xs border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Категория</label>
            <input type="text" id="filter-category"
                   class="mt-1 block max-w-xs border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Профессия</label>
            <input type="text" id="filter-profession"
                   class="mt-1 block max-w-xs border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Статус</label>
            <input type="text" id="filter-status"
                   class="mt-1 block max-w-xs border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        <!--        Поле ввода табельного номера-->
        <div>
            <label class="block text-sm font-medium text-gray-700">Табельный номер</label>
            <input type="text" id="filter-service-number"
                   class="mt-1 block max-w-xs border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        <!--        Поле ввода фамилии-->
        <div>
            <label class="block text-sm font-medium text-gray-700">Фамилия</label>
            <input type="text" id="filter-surname"
                   class="mt-1 block max-w-xs border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
    </div>
</div>

<!-- Главная таблица -->
<div class="overflow-x-auto overflow-y-auto max-h-[80vh] border rounded-md shadow-sm">
    <table>
        <thead>
        <tr>
            <th>Наименование КСП</th>
            <th>Профессия</th>
            <th>Статус</th>
            <th>Таб №</th>
            <th>Ф.И.О.</th>
            <th>Тариф / Оклад</th>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
            <th>5</th>
            <th>6</th>
            <th>7</th>
            <th>8</th>
            <th>9</th>
            <th>10</th>
            <th>11</th>
            <th>12</th>
            <th>13</th>
            <th>14</th>
            <th>15</th>
            <th>16</th>
            <th>17</th>
            <th>18</th>
            <th>19</th>
            <th>20</th>
            <th>21</th>
            <th>22</th>
            <th>23</th>
            <th>24</th>
            <th>25</th>
            <th>26</th>
            <th>27</th>
            <th>28</th>
            <th>29</th>
            <th>30</th>
            <th>31</th>
        </tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>
</div>

<!-- Edit Mode Controls -->
<div id="edit-controls" class="mt-6 bg-white p-4 rounded-lg shadow-md hidden">
    <h2 class="text-lg font-semibold mb-4">Редактирование записи</h2>
    <div class="flex space-x-4">
        <button id="save-btn"
                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
            Сохранить изменения
        </button>
        <button id="cancel-btn"
                class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
            Отменить
        </button>
    </div>
    <p class="mt-2 text-sm text-gray-600">
        Кликните по ячейке в таблице для выбора значения из выпадающего списка.
    </p>
</div>

<!-- Легенда значений -->
<div class="mt-6 bg-white p-4 rounded-lg shadow-md">
    <h2 class="text-lg font-semibold mb-4">Легенда значений</h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="flex items-center">
            <div class="w-6 h-6 bg-red-100 border border-red-300 rounded mr-2"></div>
            <span>Б - Больничный</span>
        </div>
        <div class="flex items-center">
            <div class="w-6 h-6 bg-blue-100 border border-blue-300 rounded mr-2"></div>
            <span>О - Отпуск</span>
        </div>
        <div class="flex items-center">
            <div class="w-6 h-6 bg-green-100 border border-green-300 rounded mr-2"></div>
            <span>1 - Рабочий день</span>
        </div>
        <div class="flex items-center">
            <div class="w-6 h-6 bg-amber-100 border border-amber-300 rounded mr-2"></div>
            <span>ПС - Простой предприятия</span>
        </div>
        <div class="flex items-center">
            <div class="w-6 h-6 bg-purple-100 border border-purple-300 rounded mr-2"></div>
            <span>ДО - Декретный отпуск</span>
        </div>
        <div class="flex items-center">
            <div class="w-6 h-6 bg-indigo-100 border border-indigo-300 rounded mr-2"></div>
            <span>БД - Бесплатный день</span>
        </div>
        <div class="flex items-center">
            <div class="w-6 h-6 bg-cyan-100 border border-cyan-300 rounded mr-2"></div>
            <span>Г - Служит</span>
        </div>
        <div class="flex items-center">
            <div class="w-6 h-6 bg-yellow-100 border border-yellow-300 rounded mr-2"></div>
            <span>В - Выходной</span>
        </div>
        <div class="flex items-center">
            <div class="w-6 h-6 bg-gray-100 border border-gray-300 rounded mr-2"></div>
            <span>- - Не работает</span>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}

<script>
    let data = [];

    // Получить цвет ячейки на основе значения
    function getCellColor(value) {
        switch(value) {
            case 'Б':  return 'bg-red-100 text-red-800 border border-red-300';
            case 'О':  return 'bg-blue-100 text-blue-800 border border-blue-300';
            case '1':  return 'bg-green-100 text-green-800 border border-green-300';
            case 'ПС': return 'bg-amber-100 text-amber-800 border border-amber-300';
            case 'ДО': return 'bg-purple-100 text-purple-800 border border-purple-300';
            case 'БД': return 'bg-indigo-100 text-indigo-800 border border-indigo-300';
            case 'Г':  return 'bg-cyan-100 text-cyan-800 border border-cyan-300';
            case 'В':  return 'bg-yellow-100 text-yellow-800 border border-yellow-300';
            case 'в':  return 'bg-yellow-100 text-yellow-800 border border-yellow-300';
            case '-':  return 'bg-gray-100 text-gray-800 border border-gray-300';
            default:   return 'bg-white text-black border border-gray-200';
        }
    }

    // Рендеринг таблицы
    function renderTable() {
        const tbody = document.getElementById('table-body');
        const filterKsp = document.getElementById('filter-ksp').value;
        const filterName = document.getElementById('filter-name').value;
        const filterCategory = document.getElementById('filter-category').value;
        const filterProfession = document.getElementById('filter-profession').value;
        const filterStatus = document.getElementById('filter-status').value;
        const filterServiceNumber = document.getElementById('filter-service-number').value;
        const filterSurname = document.getElementById('filter-surname').value;

        const filteredData = data.filter(row => {
            return (
            (!filterKsp || row.КСП.includes(filterKsp)) &&
            (!filterName || row.Наименование.toLowerCase().includes(filterName.toLowerCase())) &&
            (!filterCategory || row.Категория.toLowerCase().includes(filterCategory.toLowerCase())) &&
            (!filterProfession || row.Профессия.toLowerCase().includes(filterProfession.toLowerCase())) &&
            (!filterStatus || row.Статус.toLowerCase().includes(filterStatus.toLowerCase())) &&
            (!filterServiceNumber || row.Таб.includes(filterServiceNumber)) &&
            (!filterSurname || row.ФИО.toLowerCase().includes(filterSurname.toLowerCase()))
            );
        });

        tbody.innerHTML = '';

        filteredData.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="w-2 py-3 whitespace-normal break-words text-sm text-gray-900">${row.Наименование}</td>
                <td class="w-2 py-3 whitespace-normal break-words text-sm text-gray-900">${row.Профессия}</td>
                <td class="w-2 py-3 whitespace-normal break-words text-sm text-gray-900">${row.Статус}</td>
                <td class="w-2 py-3 whitespace-nowrap text-sm text-gray-900">${row.Таб}</td>
                <td class="w-2 py-3 whitespace-normal break-words text-sm text-gray-900">${row.ФИО}</td>
                <td class="w-2 py-3 whitespace-nowrap text-sm text-gray-900">${row.Тариф}</td>
            `;

            row.days.forEach(day => {
                const td = document.createElement('td');
                td.className = `w-2 py-2 whitespace-nowrap text-sm ${getCellColor(day)} text-center`;
                td.textContent = day;
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });
    }

    // Загрузка данных
    async function loadData() {
        try {
            const response = await fetch("/data_11");
            if (!response.ok) throw new Error("Ошибка загрузки данных");
            data = await response.json();
            renderTable();
        } catch (error) {
            console.error("Ошибка при загрузке данных:", error);
            document.getElementById('table-body').innerHTML = `
                <tr><td colspan="36" class="text-center py-4 text-red-600">Ошибка загрузки данных</td></tr>
            `;
        }
    }

    // Фильтрация
    document.getElementById('filter-ksp').oninput = renderTable;
    document.getElementById('filter-name').oninput = renderTable;
    document.getElementById('filter-category').oninput = renderTable;
    document.getElementById('filter-profession').oninput = renderTable;
    document.getElementById('filter-status').oninput = renderTable;
    document.getElementById('filter-service-number').oninput = renderTable;
    document.getElementById('filter-surname').oninput = renderTable;

    // Загрузка при старте
    loadData();
</script>

{% endblock %}
